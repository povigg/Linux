# How to migrate Redis Cluster instances to new host

This procedure will help you to move existing Redis Cluster instances to new server. It will create new instances, join them to cluster and remove old ones. If you need to migrate more than one server, do it `ONE-BY-ONE`, repeating procedure bellow.  
Follow this procedure, making needed changes in example code. We will be using `redis-cluster-hogwarts` as an example.

Usefull tools to monitor the process:
- [Grafana dashboard 1](https://grafana.int.vinted.com/d/NBPfwuoZk/node-exporter-compare?orgId=1)
- [Grafana dashboard 2](https://grafana.int.vinted.com/d/qHZW_Z6Gk/redis-clusters?orgId=1&refresh=30s)
- [Consul](http://consul.service.consul:8500/ui/ams1/nodes)


1. Create alert silencer in [Alertmanager](http://alertmanager-exporter.service.consul:9093/#/silences):
```shell
cluster="hogwarts"
service="redis-exporter"
```
1. Enable consul maintenance on both, old and new servers
```shell
ssh SERVER-NAME "sudo -i consul maint -enable -reason  'Maintenance-Reason-Here'" 
```
1. Enable cleanup on old server
```shell
knife exec -E "nodes.find('fqdn:OLD-SERVER-FQDN') {|n| n.normal['vinted-redis2']['cleanup']['zero_nodes'] = true; n.save}" --profile ams1
```
1. Failover master out from old server (only needs to be done when working in main reagion, ams1 in our case)
```shell
knife redis-cluster failover-cluster --name CLUSTER-NAME --server-address FQDN --primary-region ams1
```
1. Remove role from old server and run cinc-client BEFORE adding role to new server
    - Remove role
    ```shell
    knife node run_list remove SERVER-NAME 'role[redis-cluster-hogwarts]'
    ```
    - Run cinc-client
    ```shell
    ssh SERVER-NAME "sudo cinc-client"
    ```
    Extra tip: to run cinc-client quicker, you can stop running services manually
    - Check running services
    ```shell
    systemctl status redis@cluster_hogwarts_6* | grep since
    ```
    - Stop services
    ```shell
    sudo systemctl stop redis@cluster_hogwarts_6*
    ```
1. Add role to the new server and run cinc-client
    - Add role
    ```shell
    knife node run_list add SERVER-NAME 'role[redis-cluster-hogwarts]'
    ```
    - Run cinc-client
    ```shell
    ssh SERVER-NAME "sudo cinc-client"
    ```
1. Tell cluster to forget old instances
```shell
knife redis-cluster forget-disconnected --name hogwarts --primary-region ams1
```

1. Add new instances to cluster. Use [Consul](http://consul.service.consul:8500/ui/ams1/nodes) to monitor the progress. You might need to run this command a few times, until all instances are added. Do not use `--skip-waiting-for-replica` option, as this will most likely cause problems while adding instances. 
```shell
knife redis-cluster add-instances --name hogwarts --primary-region ams1 -y
```

1. Return masters to right servers if failover was used
```shell
knife redis-cluster ensure-topology --name hogwarts --primary-region ams1
```

1. Disable cleanup on old server
```shell
knife exec -E "nodes.find('fqdn:OLD-SERVER-FQDN') {|n| n.normal.delete('vinted-redis2'); n.save}"
```

1. Disable consul maintenance on both servers
```shell
ssh SERVER-NAME "sudo -i consul maint -disable"
```
